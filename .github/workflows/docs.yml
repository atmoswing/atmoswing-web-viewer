name: Documentation

on:
  push:
    branches:
      - main
      - dev
    paths:
      - 'src/**/*.js'
      - 'src/**/*.jsx'
      - 'generate-docs.js'
      - 'jsdoc.config.json'
      - '.github/workflows/docs.yml'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate documentation
        run: npm run docs

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: docs/
          retention-days: 30

      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: 'docs: Update documentation [skip ci]'

      - name: Comment PR with documentation link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const docsPath = './docs/README.md';

            if (fs.existsSync(docsPath)) {
              const body = `## ðŸ“š Documentation Generated

              Documentation has been successfully generated for this PR.

              You can download the documentation artifacts from this workflow run.

              Once merged to main, the documentation will be automatically deployed to GitHub Pages.`;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }


